generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ================= ENUMY =================
 */
enum UserRole {
  USER
  ADMIN
}

enum SharePermission {
  READ
  WRITE
}

enum EffectKind {
  WEAPON
  CRITICAL
}

enum WeaponProfileEffectMode {
  ADD
  REMOVE
}

enum PerkBehavior {
  NONE
  COMPANION_ROBOT
  COMPANION_BEAST
}

enum UnitTemplateTag {
  CHAMPION
  GRUNT
  COMPANION
  LEGENDS
}

enum StatKeySpecial {
  S
  P
  E
  C
  I
  A
  L
}

enum PerkCategory {
  REGULAR
  AUTOMATRON
}

enum ChemRarity {
  COMMON
  UNCOMMON
}

/**
 * ============ USERS / ARMIES ============
 */
model User {
  id        String   @id @default(cuid())
  name      String   @unique
  passwordHash String?
  role      UserRole @default(USER)
  photoBytes Bytes?
  photoMime  String?
  photoEtag  String?
  createdAt DateTime @default(now())

  armies Army[]
  shares ArmyShare[]
}

model Army {
  id        String @id @default(cuid())
  name      String
  factionId String
  tier      Int
  // Resources - aggregate values without history
  caps  Int @default(0)
  parts Int @default(0)
  scout Int @default(0)
  reach Int @default(0)
  exp   Int @default(0)
  ploys Int @default(0)
  // << NEW >>
  activeGoalSetId String?
  activeGoalSet   FactionGoalSet?    @relation(fields: [activeGoalSetId], references: [id])
  goalProgress    ArmyGoalProgress[]

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])
  // Subfaction is optional: null = base faction (standard).
  subfactionId String?
  subfaction   Subfaction? @relation(fields: [subfactionId], references: [id])

  faction Faction        @relation(fields: [factionId], references: [id])
  units   UnitInstance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shares   ArmyShare[]
  publicShare ArmyPublicShare?
  chems    ArmyChem[]
  HomeTurf HomeTurf?
}

model ArmyGoalProgress {
  id        String   @id @default(cuid())
  armyId    String
  goalId    String
  ticks     Int      @default(0) // Progress ticks toward goal target
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  army Army        @relation(fields: [armyId], references: [id])
  goal FactionGoal @relation(fields: [goalId], references: [id])

  @@unique([armyId, goalId])
  @@index([armyId])
  @@index([goalId])
}

model ArmyShare {
  id        String          @id @default(cuid())
  armyId    String
  userId    String
  perm      SharePermission @default(READ)
  createdAt DateTime        @default(now())

  army Army @relation(fields: [armyId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([armyId, userId])
}

model ArmyPublicShare {
  id        String   @id @default(cuid())
  armyId    String   @unique
  token     String   @unique
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  army Army @relation(fields: [armyId], references: [id], onDelete: Cascade)

  @@index([token, enabled])
}

/**
 * ============ FACTIONS AND LIMITS ============
 */
model Faction {
  id   String @id @default(cuid())
  name String @unique

  limits        FactionLimit[]
  // unitTemplates: linked through M:N (UnitTemplateFaction)
  unitTemplates UnitTemplateFaction[]
  armies        Army[]

  goalSets     FactionGoalSet[]
  upgradeRules FactionUpgradeRule[]

  subfactions Subfaction[]
}

model FactionLimit {
  id        String @id @default(cuid())
  factionId String
  tag       String
  tier1     Int?
  tier2     Int?
  tier3     Int?

  faction Faction @relation(fields: [factionId], references: [id])

  @@index([factionId, tag])
}

/**
 * ============ WEAPONS, PROFILES, EFFECTS ============
 * - WeaponTemplate stores base stats and base effects (weapon/critical)
 * - WeaponProfile is an upgrade (multiple can be selected); it overrides fields / adds rating
 */
model WeaponTemplate {
  id        String   @id @default(cuid())
  name      String
  imagePath String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Base values (rating/parts are optional and may be null)
  baseType   String @default("")
  baseTest   String @default("")
  baseParts  Int?
  baseRating Int?
  // Base effects (independent from profiles)
  baseEffects WeaponBaseEffect[]

  profiles         WeaponProfile[]
  optionsAsWeapon1 UnitWeaponOption[] @relation("OptionWeapon1")
  optionsAsWeapon2 UnitWeaponOption[] @relation("OptionWeapon2")
  // subfactions: allow/deny
  subfactionAllows SubfactionWeaponAllow[]
  subfactionDenies SubfactionWeaponDeny[]

  instances WeaponInstance[]
}

model WeaponBaseEffect {
  id       String @id @default(cuid())
  weaponId String
  effectId String
  valueInt Int?
  valueText String?

  weapon WeaponTemplate @relation(fields: [weaponId], references: [id])
  effect Effect         @relation(fields: [effectId], references: [id])

  @@unique([weaponId, effectId])
  @@index([weaponId])
  @@index([effectId])
}

model WeaponProfile {
  id       String @id @default(cuid())
  weaponId String
  // Upgrade values - overrides/additions
  order         Int     @default(0)
  typeOverride  String?
  testOverride  String?
  partsOverride Int?
  ratingDelta   Int?

  weapon  WeaponTemplate        @relation(fields: [weaponId], references: [id])
  effects WeaponProfileEffect[]

  @@index([weaponId])
}

model Effect {
  id            String     @id @default(cuid())
  name          String
  kind          EffectKind
  description   String
  requiresValue Boolean    @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  profiles         WeaponProfileEffect[]
  WeaponBaseEffect WeaponBaseEffect[]
}

model WeaponProfileEffect {
  id        String @id @default(cuid())
  profileId String
  effectId  String
  valueInt  Int?
  valueText String?
  effectMode WeaponProfileEffectMode @default(ADD)

  profile WeaponProfile @relation(fields: [profileId], references: [id])
  effect  Effect        @relation(fields: [effectId], references: [id])

  @@unique([profileId, effectId])
  @@index([effectId])
}

/**
 * ============ PERKS ============
 */
model Perk {
  id            String       @id @default(cuid())
  name          String
  description   String
  // Perk category: standard vs automatron
  category      PerkCategory @default(REGULAR)
  // SPECIAL requirements for unit stats (optional)
  statKey       StatKeySpecial?
  minValue      Int?         // null = no requirement; in practice we use >=
  // Innate perk: should not be added in army view, only attached to templates
  isInnate      Boolean      @default(false)

  requiresValue Boolean      @default(false)
  startAllowed  Boolean      @default(false)
  behavior      PerkBehavior @default(NONE)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  startOnUnits  UnitStartPerk[]
  chosenOnUnits UnitChosenPerk[]
}

/**
 * ============ UNIT TEMPLATES ============
 */
model UnitTemplate {
  id   String @id @default(cuid())
  name String
  // Global template = available for all factions
  isGlobal Boolean @default(false)
  // Predefined unit role/quality (for filtering and limits)
  roleTag UnitTemplateTag?
  // Extra tag: whether this template can be a leader (does not exclude roleTag)
  isLeader Boolean @default(false)

  hp Int @default(3)
  s  Int @default(5)
  p  Int @default(5)
  e  Int @default(5)
  c  Int @default(5)
  i  Int @default(5)
  a  Int @default(5)
  l  Int @default(5)

  baseRating Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // M:N factions
  factions UnitTemplateFaction[]

  options      UnitWeaponOption[]
  startPerks   UnitStartPerk[]
  UnitInstance UnitInstance[]
  // subfactions: allow/deny
  subfactionAllows SubfactionUnitAllow[]
  subfactionDenies SubfactionUnitDeny[]

  @@index([isGlobal])
}

model UnitTemplateFaction {
  id         String @id @default(cuid())
  unitId     String
  factionId  String

  unit    UnitTemplate @relation(fields: [unitId], references: [id])
  faction Faction      @relation(fields: [factionId], references: [id])

  @@unique([unitId, factionId])
  @@index([factionId])
  @@index([unitId])
}

// =====================================================
//  Units: weapon loadouts, starting perks, army instances
// =====================================================

model UnitWeaponOption {
  id        String @id @default(cuid())
  unitId    String
  weapon1Id String
  weapon2Id String?
  costCaps  Int    @default(0)
  rating    Int?

  unit    UnitTemplate   @relation(fields: [unitId], references: [id])
  weapon1 WeaponTemplate @relation("OptionWeapon1", fields: [weapon1Id], references: [id])
  weapon2 WeaponTemplate? @relation("OptionWeapon2", fields: [weapon2Id], references: [id])

  selectedBy UnitInstance[] @relation("SelectedOption")

  @@index([unitId])
  @@index([weapon1Id])
  @@index([weapon2Id])
}

model UnitStartPerk {
  id       String @id @default(cuid())
  unitId   String
  perkId   String
  valueInt Int?

  unit UnitTemplate @relation(fields: [unitId], references: [id])
  perk Perk         @relation(fields: [perkId], references: [id])

  @@unique([unitId, perkId])
  @@index([perkId])
  @@index([unitId])
}

model UnitInstance {
  id         String   @id @default(cuid())
  armyId     String
  unitId     String
  optionId   String?

  wounds     Int      @default(0)
  present    Boolean  @default(true)
  photoPath  String?
  photoBytes Bytes?
  photoMime  String?
  photoEtag  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  army           Army           @relation(fields: [armyId], references: [id])
  unit           UnitTemplate   @relation(fields: [unitId], references: [id])
  selectedOption UnitWeaponOption? @relation("SelectedOption", fields: [optionId], references: [id])
  // Selected perks on an instance (without SPECIAL upgrades)
  chosenPerks UnitChosenPerk[]

  upgrades StatUpgrade[]
  weapons  WeaponInstance[]
  // Marks this unit as temporary leader in the army
  temporaryLeader Boolean @default(false)

  @@index([armyId])
  @@index([unitId])
  @@index([optionId])
}

model UnitChosenPerk {
  id       String @id @default(cuid())
  unitId   String
  perkId   String
  valueInt Int?

  unit UnitInstance @relation(fields: [unitId], references: [id], onDelete: Cascade)
  perk Perk         @relation(fields: [perkId], references: [id])

  @@unique([unitId, perkId])
  @@index([perkId])
  @@index([unitId])
}

model WeaponInstance {
  id         String   @id @default(cuid())
  unitId     String
  templateId String
  // "__profile:<profileId>" - multiple entries can be active at once
  activeMods String[] @default([])

  unit     UnitInstance   @relation(fields: [unitId], references: [id])
  template WeaponTemplate @relation(fields: [templateId], references: [id])

  @@index([unitId])
  @@index([templateId])
}

model StatUpgrade {
  id      String   @id @default(cuid())
  unitId  String
  statKey String // "S","P","E","C","I","A","L","hp"
  delta   Int
  at      DateTime @default(now())

  unit UnitInstance @relation(fields: [unitId], references: [id])

  @@index([unitId])
}

/**
 * ============ GOALS & UPGRADE RULES ============
 */
model FactionGoalSet {
  id        String   @id @default(cuid())
  factionId String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  faction Faction       @relation(fields: [factionId], references: [id])
  goals   FactionGoal[]
  Army    Army[]

  @@index([factionId, name])
}

model FactionGoal {
  id          String   @id @default(cuid())
  setId       String
  tier        Int
  description String
  target      Int
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  set              FactionGoalSet     @relation(fields: [setId], references: [id])
  ArmyGoalProgress ArmyGoalProgress[]

  @@index([setId, tier, order])
}

model FactionUpgradeRule {
  id             String   @id @default(cuid())
  factionId      String
  statKey        String // "hp","S","P","E","C","I","A","L"
  ratingPerPoint Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now())

  faction Faction @relation(fields: [factionId], references: [id])

  @@unique([factionId, statKey])
  @@index([factionId])
}

model HomeTurf {
  id        String   @id @default(cuid())
  armyId    String   @unique
  hazard    String   @default("")
  hazardDefId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  army       Army                   @relation(fields: [armyId], references: [id])
  hazardDef  HomeHazardDefinition?  @relation(fields: [hazardDefId], references: [id], onDelete: SetNull)
  facilities HomeFacility[]

  @@index([hazardDefId])
}

model HomeFacility {
  id     String @id @default(cuid())
  turfId String
  name   String
  facilityDefId String?

  turf        HomeTurf                  @relation(fields: [turfId], references: [id])
  facilityDef HomeFacilityDefinition?   @relation(fields: [facilityDefId], references: [id], onDelete: SetNull)

  @@index([turfId])
  @@index([facilityDefId])
  @@unique([turfId, facilityDefId])
}

model HomeFacilityDefinition {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  selections HomeFacility[]

  @@index([sortOrder, name])
}

model HomeHazardDefinition {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  turfs HomeTurf[]

  @@index([sortOrder, name])
}

model Chem {
  id        String     @id @default(cuid())
  name      String     @unique
  rarity    ChemRarity
  costCaps  Int
  effect    String
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  armies ArmyChem[]

  @@index([rarity, sortOrder, name])
}

model ArmyChem {
  id       String @id @default(cuid())
  armyId   String
  chemId   String
  quantity Int    @default(0)

  army Army @relation(fields: [armyId], references: [id], onDelete: Cascade)
  chem Chem @relation(fields: [chemId], references: [id])

  @@unique([armyId, chemId])
  @@index([armyId])
  @@index([chemId])
}

model Subfaction {
  id        String   @id @default(cuid())
  factionId String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  faction Faction @relation(fields: [factionId], references: [id])
  armies  Army[]

  unitAllows   SubfactionUnitAllow[]
  unitDenies   SubfactionUnitDeny[]
  weaponAllows SubfactionWeaponAllow[]
  weaponDenies SubfactionWeaponDeny[]

  @@unique([factionId, name])
  @@index([factionId])
}

model SubfactionUnitAllow {
  id           String @id @default(cuid())
  subfactionId String
  unitId       String

  subfaction Subfaction   @relation(fields: [subfactionId], references: [id])
  unit       UnitTemplate @relation(fields: [unitId], references: [id])

  @@unique([subfactionId, unitId])
  @@index([unitId])
}

model SubfactionUnitDeny {
  id           String @id @default(cuid())
  subfactionId String
  unitId       String

  subfaction Subfaction   @relation(fields: [subfactionId], references: [id])
  unit       UnitTemplate @relation(fields: [unitId], references: [id])

  @@unique([subfactionId, unitId])
  @@index([unitId])
}

model SubfactionWeaponAllow {
  id           String @id @default(cuid())
  subfactionId String
  weaponId     String

  subfaction Subfaction    @relation(fields: [subfactionId], references: [id])
  weapon     WeaponTemplate @relation(fields: [weaponId], references: [id])

  @@unique([subfactionId, weaponId])
  @@index([weaponId])
}

model SubfactionWeaponDeny {
  id           String @id @default(cuid())
  subfactionId String
  weaponId     String

  subfaction Subfaction    @relation(fields: [subfactionId], references: [id])
  weapon     WeaponTemplate @relation(fields: [weaponId], references: [id])

  @@unique([subfactionId, weaponId])
  @@index([weaponId])
}

